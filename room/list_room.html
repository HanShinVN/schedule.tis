<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIS | L·ªãch ƒë√£ book ph√≤ng h·ªçp</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png"> 
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    
    <style>
        :root { --tis-red: #D61F2F; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f4f7f6; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            padding: 20px;
        }

        .fc-header-toolbar { margin-bottom: 1.5rem !important; }
        .fc-button-primary { background-color: var(--tis-red) !important; border-color: var(--tis-red) !important; }
        .fc-button-primary:hover { background-color: #b81826 !important; }
        .fc-event { 
            cursor: pointer; 
            border: none !important; 
            padding: 4px 8px !important;
            border-radius: 6px !important;
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .fc-event:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .fc-event, 
        .fc-event .fc-event-main, 
        .fc-event .fc-event-time, 
        .fc-event .fc-event-title {
            color: #ffffff !important; 
            text-decoration: none !important;
        }

        .fc-daygrid-event-dot { 
            display: none !important; 
        }

        .event-phong-lon { background: linear-gradient(135deg, #D61F2F, #b81826) !important; }
        .event-phong-nho { background: linear-gradient(135deg, #4b5563, #374151) !important; }

        .fc-daygrid-day-number {
            color: #4b5563 !important;
            font-weight: 600;
            text-decoration: none !important;
        }
        .fc-daygrid-day-number:hover {
            color: var(--tis-red) !important;
        }

        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner-border text-danger mb-3" role="status"></div>
        <h5 class="fw-bold">ƒêang t·∫£i l·ªãch ph√≤ng h·ªçp...</h5>
    </div>

    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4 px-3">
            <div class="d-flex align-items-center">
                <img src="logo.png" alt="Logo" style="height: 45px;" class="me-3">
                <h4 class="mb-0 fw-bold text-dark">L·ªäCH PH√íNG H·ªåP TIS</h4>
            </div>
            <a href="room.html" class="btn btn-danger rounded-pill fw-bold px-4 shadow-sm">
                <i class="bi bi-plus-lg me-1"></i> ƒê·∫∂T PH√íNG NGAY
            </a>
        </div>

        <div class="card glass-card">
            <div id="calendar"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const ROOM_API_URL = "https://script.google.com/macros/s/AKfycby3f_cFZp8YP6AH9DTBipDves8fMZls7aIkCKuc4iKLrWbL81X8PlTh4bNFUhjhsP8wtw/exec";

        document.addEventListener('DOMContentLoaded', function() {
            fetchEvents();
        });

        async function fetchEvents() {
            try {
                const response = await fetch(ROOM_API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8",
                    },
                    body: JSON.stringify({ action: 'GET_ROOM_DATA' })
                });
                const result = await response.json();
                
                document.getElementById('loadingOverlay').style.display = 'none';

                if (result.status === 'success') {
                    const events = result.data.map(item => {
                        let formattedDate = item.date;
                        
                        if (item.date.includes('/')) {
                            const dateParts = item.date.split('/');
                            formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; 
                        } 
                        else if (item.date.includes('T')) {
                            formattedDate = item.date.split('T')[0];
                        }
                        console.log(`ƒêang t·∫£i: ${item.room} | Start: ${formattedDate}T${item.start}:00`);
                        
                        return {
                            title: `${item.room}: ${item.fullName}`,
                            start: `${formattedDate}T${item.start}:00`,
                            end: `${formattedDate}T${item.end}:00`,
                            extendedProps: {
                                room: item.room,
                                user: item.fullName,
                                title: item.title,
                                note: item.note,
                                time: `${item.start} - ${item.end}`
                            },
                            className: item.room.includes('L·ªõn') ? 'event-phong-lon' : 'event-phong-nho'
                        };
                    });

                    initCalendar(events);
                } else {
                    console.error("L·ªói t·ª´ Google Script:", result.message);
                }
            } catch (error) {
                console.error("L·ªói fetch data:", error);
                document.getElementById('loadingOverlay').innerHTML = "<h5 class='text-danger'>L·ªói k·∫øt n·ªëi d·ªØ li·ªáu! H√£y ki·ªÉm tra Console (F12).</h5>";
            }
        }

        function initCalendar(events) {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'vi',
                contentHeight: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: 'H√¥m nay',
                    month: 'Th√°ng',
                    week: 'Tu·∫ßn',
                    day: 'Ng√†y'
                },
                events: events,
                eventClick: function(info) {
                    const p = info.event.extendedProps;
                    Swal.fire({
                        title: `<span style="color:var(--tis-red)">${p.room}</span>`,
                        html: `
                            <div class="text-start">
                                <p><strong>üë§ Ng∆∞·ªùi ƒë·∫∑t:</strong> ${p.user}</p>
                                <p><strong>‚è∞ Th·ªùi gian:</strong> ${p.time}</p>
                                <p><strong>üìù N·ªôi dung:</strong> ${p.title}</p>
                                <p><strong>üìå Ghi ch√∫:</strong> ${p.note || 'Kh√¥ng c√≥'}</p>
                            </div>
                        `,
                        icon: 'info',
                        confirmButtonColor: '#D61F2F'
                    });
                }
            });
            calendar.render();
        }
    </script>
</body>
</html>